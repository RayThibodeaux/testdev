package main
 
import (
    "encoding/json"
    "flag"
    "fmt"
    "log"
    "net/http"
    "strings"
)
 
// LoginRequest represents the incoming JSON body.
type LoginRequest struct {
    Username string `json:"username"`
    Password string `json:"password"`
}
 
// LoginResponse is the JSON response.
type LoginResponse struct {
    Status         string `json:"status"`
    Message        string `json:"message"`
    SimulatedQuery string `json:"simulated_query"`
    Note           string `json:"note"`
}
 
func main() {
    port := flag.Int("port", 8080, "port to listen on")
    flag.Parse()
 
    // Honeypot API endpoint
    http.HandleFunc("/api/login", loginHandler)
 
    // Swagger / docs endpoints
    http.HandleFunc("/", docsHandler)
    http.HandleFunc("/docs", docsHandler)
    http.HandleFunc("/swagger.json", swaggerJSONHandler)
 
    addr := fmt.Sprintf(":%d", *port)
    log.Printf("Starting SQL-injection honeypot on %s", addr)
    log.Printf("Docs:   http://localhost%s/docs", addr)
    log.Printf("Swagger: http://localhost%s/swagger.json", addr)
    log.Fatal(http.ListenAndServe(addr, nil))
}
 
func loginHandler(w http.ResponseWriter, r *http.Request) {
    if r.Method != http.MethodPost {
        http.Error(w, "Only POST allowed", http.StatusMethodNotAllowed)
        return
    }
 
    var req LoginRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        http.Error(w, "Invalid JSON", http.StatusBadRequest)
        return
    }
 
    // ---------------------------------------------------------
    // SQL INJECTION DETECTION
    // ---------------------------------------------------------
    injectionPatterns := []string{
        "'", "\"", ";", "--", "/*", "*/",
        " OR ", " or ", " Or ", "oR ",
        "1=1", "1 = 1",
        "DROP", "drop", "DELETE", "delete",
        "INSERT", "insert",
    }
 
    looksInjected := false
 
    // Check username + password for injection signatures
    for _, p := range injectionPatterns {
        if strings.Contains(req.Username, p) || strings.Contains(req.Password, p) {
            looksInjected = true
            break
        }
    }
 
    // ---------------------------------------------------------
    // BUILD SIMULATED SQL PAYLOAD (ONLY IF INJECTION DETECTED)
    // ---------------------------------------------------------
    var simulated string
    if looksInjected {
        // This string is intentionally built in a vulnerable-looking way
        simulated = "SELECT id, username FROM users WHERE username = '" +
            req.Username + "' AND password = '" + req.Password + "'"
 
        fakeExec(simulated) // Log it for scanner visibility
    }
 
    resp := LoginResponse{
        Status:         "ok",
        Message:        "Processed request.",
        SimulatedQuery: simulated,
        Note:           "This is a honeypot. The SQL string is never executed. It is only returned/logged when input looks like SQL injection.",
    }
 
    w.Header().Set("Content-Type", "application/json")
    _ = json.NewEncoder(w).Encode(resp)
}
 
// fakeExec pretends to execute a SQL query but only logs it.
// There is NO database interaction in this honeypot.
func fakeExec(query string) {
    log.Printf("[HONEYPOT] would execute SQL: %s", query)
}
 
// docsHandler serves a simple Swagger-like UI page that points to /swagger.json.
func docsHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    fmt.Fprint(w, `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>SQL Honeypot API Docs</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { padding: 10px 20px; background: #222; color: #f5f5f5; }
    main { padding: 20px; }
    pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    .note { margin-top: 10px; color: #555; }
  </style>
</head>
<body>
<header>
  <h1>SQL Honeypot API</h1>
</header>
<main>
  <p>This is a test/honeypot service that simulates a JSON login API with SQL-like behavior for scanners.</p>
  <p>OpenAPI/Swagger JSON: <a href="/swagger.json">/swagger.json</a></p>
 
  <h2>Endpoint</h2>
  <p><code>POST /api/login</code></p>
  <h3>Request Body (JSON)</h3>
  <pre>{
  "username": "string",
  "password": "string"
}</pre>
 
  <h3>Example curl</h3>
  <p><strong>Normal:</strong></p>
  <pre>curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":"mypassword"}'</pre>
 
  <p><strong>Injection-style:</strong></p>
  <pre>curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"admin\",\"password\":\"' OR 1=1 --\"}"</pre>
 
  <p class="note">
    When the input looks like SQL injection, the response will include a
    <code>simulated_query</code> field that contains a vulnerable-looking SQL statement.
    No real database is used.
  </p>
</main>
</body>
</html>`)
}
 
// swaggerJSONHandler returns a minimal OpenAPI/Swagger document.
func swaggerJSONHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/json")
    // Very small OpenAPI 3.0 spec describing /api/login
    fmt.Fprint(w, `{
  "openapi": "3.0.0",
  "info": {
    "title": "SQL Honeypot API",
    "version": "1.0.0",
    "description": "Test API that simulates a JSON login endpoint with SQL-like behavior for scanners. No real database is used."
  },
  "paths": {
    "/api/login": {
      "post": {
        "summary": "Login honeypot endpoint",
        "description": "Accepts username/password JSON and, when payload looks like SQL injection, returns a simulated SQL query string.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "username": { "type": "string" },
                  "password": { "type": "string" }
                },
                "required": ["username", "password"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Honeypot response",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": { "type": "string" },
                    "message": { "type": "string" },
                    "simulated_query": { "type": "string" },
                    "note": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}`)
}
